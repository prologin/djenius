version: "3"

services:
  frontend:
    build:
      context: ../frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      DEV: 1
      DJENIUS_SOCKET_HOST: localhost:80
      CHOKIDAR_USEPOLLING: "true" # Auto reload react
      CHOKIDAR_INTERVAL: 1000
      WATCHPACK_POLLING: "true"
    volumes:
      - ../frontend:/home/app
      - /home/app/node_modules
    networks:
      - radio

  backend:
    build:
      context: ../
      dockerfile: Dockerfile.backend
    restart: unless-stopped
    ports:
      - "7000:8000"
    environment:
      DEBUG: 1
      MPV: mpv:6600
      RESOLVER: http://nginx:8000
    volumes:
      - ./sock:/sock:rw # expose unix domain sockets
    networks:
      - radio

  resolver:
    build:
      context: ../
      dockerfile: Dockerfile.resolver
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      DEBUG: 1
    volumes:
      - ./sock:/sock:rw # expose unix domain sockets
    networks:
      - radio

  mpv:
    build:
      context: ./mpv/
    restart: unless-stopped
    ports:
      - "6600:6600"
    environment:
      PULSE_SERVER: unix:/run/user/1000/pulse/native
    user: "1000:1000"
    volumes:
      - /run/user/1000/pulse/native:/run/user/1000/pulse/native
    networks:
      - radio

  nginx:
    image: nginx:stable-alpine
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro # use local conf
      - ./sock:/nginx/sock:rw # expose unix domain sockets
      - ../frontend/build:/srv/frontend:ro # expose React "static" build
    networks:
      - radio

networks:
  radio:
    name: radio
